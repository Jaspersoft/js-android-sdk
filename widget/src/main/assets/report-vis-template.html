<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN"
        "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<!--suppress CheckValidXmlInScriptTagBody -->
<head xmlns="http://www.w3.org/1999/html">
    <title>TIBCO Jaspersoft</title>
    <style>
        html {height: 100%;}
        body {min-height: 100%;}
    </style>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript">

    var NativeCallbacks = {
        onInited: function () {
            return Android.onInited();
        },
        onRendered: function () {
            return Android.onRendered();
        },
        onError: function (error) {
            return Android.onError(error);
        },
        onCleared: function () {
            return Android.onCleared();
        },
        onCurrentPageChanged: function (currentPage) {
            return Android.onCurrentPageChanged(currentPage);
        },
        onPagesCountChanged: function (totalCount) {
            return Android.onPagesCountChanged(totalCount);
        },
        onHyperLinkClick: function(type, hyperlink) {
            return Android.onHyperLinkClick(type, hyperlink);
        }
    };

    window.onerror = function (message) {
        NativeCallbacks.onError(message);
        return false;
    };

    var MobileClient = (function () {
        var instance;

        function Client() {
            var report;
            var vis;
            var jrsServer;

            window.onresize = function() {
                updateRenderRect(document.documentElement.offsetWidth, document.documentElement.offsetHeight);
            }

            function setupFn(server, initialScale) {
                jrsServer = server;

                appendViewportMeta(initialScale);
                updateRenderRect(document.documentElement.offsetWidth, document.documentElement.offsetHeight);
                setupVisualizeScript(server);
            }

              function appendViewportMeta(reportScale) {
                var maxScale = reportScale * 5;
                var viewport = document.createElement('meta');
                viewport.name = "viewport";
                viewport.content = "target-densitydpi=device-dpi, width=device-width, height=device-height, initial-scale=" + reportScale + ", minimum-scale=" + reportScale +" , maximum-scale=" + maxScale + ", user-scalable=yes";
                document.head.appendChild(viewport);
            }

            function updateRenderRect(width, height) {
                var container = document.getElementById('container');

                // Because of default body margin (8px)
                var newContainerHeight = height - 16;
                var newContainerWidth = width - 16;

                container.style.height = newContainerHeight + "px";
                container.style.width = newContainerWidth + "px";

	            if (report) {
	                report.resize();
	            }
            }

            function setupVisualizeScript() {
                var visScript = document.createElement('script');
                visScript.onload = loadVisualize;
                visScript.onerror = onVisualizeLoadingFailed;
                visScript.setAttribute('src', jrsServer.url + "client/visualize.js?_opt=true");
                document.head.appendChild(visScript);
            }

            function loadVisualize() {
                var auth = {};
                if (jrsServer.pre61) {
                    auth.auth = {
                        loginFn: function(properties, request) {
                            return (new jQuery.Deferred()).resolve();
                        }
                    };
                }
                visualize(auth, onVisualizeLoaded, onVisualizeLoadingFailed);
            };

            function onVisualizeLoaded(v) {
                vis = v;
                NativeCallbacks.onInited();
            };

             function onVisualizeLoadingFailed(error) {
                var message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            };

            return {
                setup: setupFn,
                report: function () {
                    if (!report || report.isInvalid()) {
                        if (jrsServer.pre61) {
                            report = new Pre61Report(vis);
                        } else {
                            report = new BaseReport(vis);
                        }
                    }
                    return report;
                }
            }
        }

        function BaseReport(v) {
            var invalid = false;
            var vis = v;
            var hyperLinkHandler = new HyperLinkHandler();
            var reportInstance;

            this.run = function(uri, params, destination) {
                var reportBundle = prepareBaseRunReportBundle(uri, params, destination);
                this._modifyReportBundle(reportBundle);

                reportInstance = vis.report(reportBundle);
            }

            this.applyParams = function(params) {
                reportInstance.params(params).run(reportRenderedFn, reportErrorFn);
            }

            this.navigateTo = function(destination) {
                reportInstance.pages(destination).run(reportRenderedFn, reportErrorFn);
            }

            this.resize = function() {
                if (reportInstance) {
                    reportInstance.resize();
                }
            }

            this.refresh = function() {
                reportInstance.refresh(reportRenderedFn, reportErrorFn);
            }

            this.clear = function() {
                invalid = true;
                if (reportInstance && reportInstance.container()) {
                    destroyReport();
                }
                NativeCallbacks.onCleared();
            }

            this.isInvalid = function() {
                return invalid;
            }

            this._modifyReportBundle = function(reportBundle) {
                reportBundle["autoresize"] = false;
                reportBundle["chart"] = {
                    animation: false,
                    zoom: false
                };
            }

            prepareBaseRunReportBundle = function(uri, params, destination) {
                return reportBundle = {
                    resource: uri,
                    params: params,
                    scale: "width",
                    pages: destination,
                    success: reportExecutedFn,
                    error: reportErrorFn,
                    events: {
                        reportCompleted: reportCompletedFn,
                        changePagesState: currentPageChangedFn
                    },
                    linkOptions: {
                        events: {
                            click: handleHyperlinkClick
                        }
                    }
                }
            }

            destroyReport = function() {
                reportInstance.container(null);
                jQuery("#container").empty();
                reportInstance.destroy();
            }

            handleHyperlinkClick = function(event, link) {
                hyperLinkHandler.handle(event, link);
            }

            reportExecutedFn = function (){
                if (invalid) {
                    destroyReport();
                } else {
                    reportInstance.container("#container");
                    reportInstance.render(reportRenderedFn, reportErrorFn);
                }
            }

            currentPageChangedFn = function(currentPage) {
                console.log(currentPage)
                NativeCallbacks.onCurrentPageChanged(currentPage);
            }

            reportCompletedFn = function() {
                NativeCallbacks.onPagesCountChanged(reportInstance.data().totalPages);
            }

            reportRenderedFn = function() {
                NativeCallbacks.onRendered();
                NativeCallbacks.onCurrentPageChanged(parseInt(reportInstance.properties().pages));
            }

            reportErrorFn = function(error) {
                message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            }
        }

        function Pre61Report(v) {
            BaseReport.apply(this, arguments);

            this.resize = function() {
                // Resize is not supported for 6.0
            }

            this._modifyReportBundle = function(reportBundle, page, localAnchor) {
                // Disabling chart zoom and animation is not supported for 6.0
            }
        }

        function HyperLinkHandler() {
            this.handle = function(event, link) {
                var type = link.type;
                switch (type) {
                    case "ReportExecution":
                        return handleReportExecutionType(link);
                    case "LocalAnchor":
                        return handleLocalAnchorType(link);
                    case "LocalPage":
                        return handleLocalPageType(link);
                    case "RemoteAnchor":
                        return handleRemoteAnchorType(link);
                    case "RemotePage":
                        return handleRemotePageType(link);
                    case "Reference":
                        return handleReferenceType(link);
                }
            }

            filterReportParams = function (params) {
                var filters = [];
                var blackList = ["_report", "_page", "_anchor", "_output"];
                for (var key in params) {
                    var value = params[key];
                    var isFilter = (blackList.indexOf(key) < 0);
                    if (isFilter) {
                        var filter = {
                            name: key,
                            value: [value]
                        }
                        filters.splice(filters.length, 1, filter)
                    }
                }
                return filters;
            };

            handleReportExecutionType = function(link) {
                var runOptions = link.parameters;
                if (!runOptions) return;

                var reportParams = filterReportParams(link.parameters);
                var hyperlink = {
                    reportUri: runOptions._report,
                    parameters: reportParams,
                    destination: {
                        page: (runOptions._page || runOptions._anchor) ? runOptions._page : 1,
                        anchor: runOptions._anchor,
                    }
                };
                NativeCallbacks.onHyperLinkClick(link.type, JSON.stringify(hyperlink));
            };

            handleReferenceType = function (link) {
                NativeCallbacks.onHyperLinkClick(link.type, link.href);
            };

            handleLocalPageType = function (link) {
                if (!link.pages) {
                }
                NativeCallbacks.onHyperLinkClick(link.type, link.pages);
            };

            handleLocalAnchorType = function (link) {
                NativeCallbacks.onHyperLinkClick(link.type, link.anchor);
            };

            handleRemotePageType = function (link) {
                var hyperlink = {
                    resourceUri: link.href,
                    destination: {
                        page: link.pages ? link.pages : 1
                    }
                };
                NativeCallbacks.onHyperLinkClick(link.type, JSON.stringify(hyperlink));
            };

            handleRemoteAnchorType = function (link) {
                var hyperlink = {
                    resourceUri: link.href,
                    destination: {
                        anchor: link.anchor,
                    }
                };
                NativeCallbacks.onHyperLinkClick(link.type, JSON.stringify(hyperlink));
            };
        }

        return {
            getInstance: function() {
                if (!instance) {
                    instance = new Client();
                }
                return instance;
            }
        };
    })();


    </script>
</head>
<body>
<div id="container"></div>
</body>