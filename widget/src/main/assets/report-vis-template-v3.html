<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN"
        "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<!--suppress CheckValidXmlInScriptTagBody -->
<head xmlns="http://www.w3.org/1999/html">
    <title>TIBCO Jaspersoft</title>
    <style>
        html {height: 100%;}
        body {min-height: 100%;}
    </style>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript">

    var NativeCallbacks = {
        onScriptReady: function () {
            return Android.onScriptReady();
        },
        onReportRendered: function () {
            return Android.onReportRendered();
        },
        onError: function (error) {
            return Android.onError(error);
        }
    };

    window.onerror = function (message) {
        NativeCallbacks.onError(message);
        return false;
    };

    var MobileClient = (function () {
        var instance;

        function Client() {
            var report;
            var jrsServer;

            window.onresize = function() {
                updateRenderRect(document.documentElement.offsetWidth, document.documentElement.offsetHeight);
            }

            function setupFn(server, initialScale) {
                jrsServer = server;

                appendViewportMeta(initialScale);
                updateRenderRect(document.documentElement.offsetWidth, document.documentElement.offsetHeight);
                setupVisualizeScript(server);
            }

              function appendViewportMeta(reportScale) {
                var maxScale = reportScale * 5;
                var viewport = document.createElement('meta');
                viewport.name = "viewport";
                viewport.content = "target-densitydpi=device-dpi, width=device-width, height=device-height, initial-scale=" + reportScale + ", minimum-scale=" + reportScale +" , maximum-scale=" + maxScale + ", user-scalable=yes";
                document.head.appendChild(viewport);
            }

            function updateRenderRect(width, height) {
                var container = document.getElementById('container');

                // Because of default body margin (8px)
                var newContainerHeight = height - 16;
                var newContainerWidth = width - 16;

                container.style.height = newContainerHeight + "px";
                container.style.width = newContainerWidth + "px";

	            if (report) {
	                report.resize();
	            }
            }

            function setupVisualizeScript() {
                var visScript = document.createElement('script');
                visScript.onload = loadVisualize;
                visScript.setAttribute('src', jrsServer.url + "client/visualize.js?_opt=true");
                document.head.appendChild(visScript);
            }

            function loadVisualize() {
                var auth = {};
                if (jrsServer.pre61) {
                    auth.auth = {
                        loginFn: function(properties, request) {
                            return (new jQuery.Deferred()).resolve();
                        }
                    };
                }
                visualize(auth, onVisualizeLoaded, onVisualizeLoadingFailed);
            };

            function onVisualizeLoaded(v) {
                if (jrsServer.pre61) {
                    report = new Report(v, {})
                } else {
                    report = new Report(v, {
                        autoresize: false,
                        chart: {
                            animation: false,
                            zoom: false
                        }
                    })
                }
                NativeCallbacks.onScriptReady();
            };

             function onVisualizeLoadingFailed(error) {
                var message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            };

            return {
                setup: setupFn,
                report: function () {
                    return report;
                }
            }
        }

        function Report(v, initialReportBundle) {
            vis = v;
            var reportBundle = initialReportBundle;
            var reportInstance;

            function reportRenderedFn() {
                NativeCallbacks.onReportRendered();
            }

            function reportErrorFn(error) {
                message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            }

            function runFn(uri, params) {
                reportBundle["resource"] = uri;
                reportBundle["params"] = params;
                reportBundle["container"] = "#container";
                reportBundle["scale"] = "width";
                reportBundle["success"] = reportRenderedFn;
                reportBundle["error"] = reportErrorFn;

                reportInstance = vis.report(reportBundle);
            }

            function applyParamsFn(params) {
                reportInstance.params(params).run(reportRenderedFn, reportErrorFn);
            }

            return {
                run: runFn,
                applyParams: applyParamsFn,
                resize: function () {
                    if (reportInstance) {
                        reportInstance.resize();
                    }
                }
            }
        }

        return {
            getInstance: function() {
                if (!instance) {
                    instance = new Client();
                }
                return instance;
            }
        };
    })();

</script>
</head>
<body>
<div id="container"></div>
</body>