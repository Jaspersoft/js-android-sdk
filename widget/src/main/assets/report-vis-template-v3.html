<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN"
        "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<!--suppress CheckValidXmlInScriptTagBody -->
<head xmlns="http://www.w3.org/1999/html">
    <title>TIBCO Jaspersoft</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script type="text/javascript">

    var NativeCallbacks = {
        onScriptReady: function () {
            return Android.onScriptReady();
        },
        onReportRenedered: function () {
            return Android.onReportRenedered();
        },
        onError: function (error) {
            return Android.onError(error);
        },
        onHyperLinkClick: function (hyperlink) {
            var linkAsString = JSON.stringify(hyperlink);
            return Android.onHyperLinkClick(linkAsString);
        }
    };

    window.onerror = function (message) {
        NativeCallbacks.onError(message);
        return false;
    };

    var MobileClient = (function () {
        var instance;

        function Client() {
            var report;
            var jrsServer;
            var initOptions;

            function appendViewportMeta() {
                if (initOptions.deviceWidth != 0) {
                    var viewport = "<meta name='viewport' content='width=" + initOptions.deviceWidth + ", minimum-scale=0.1, maximum-scale=3, user-scalable=yes'>";
                    jQuery('head').append(viewport);
                } else if (initOptions.initialScale != 0) {

                }
            }

            function setupVisualizeScript() {
                var visScript = document.createElement('script');
                visScript.onload = loadVisualize;
                visScript.setAttribute('src', jrsServer.url + "client/visualize.js?_opt=false");
                document.head.appendChild(visScript);
            }

            function loadVisualize() {
                var auth = {};
                if (jrsServer.pre61) {
                    auth.auth = {
                        loginFn: function(properties, request) {
                            return (new jQuery.Deferred()).resolve();
                        }
                    };
                }
                visualize(auth, onVisualizeLoaded, onVisualizeLoadingFailed);
            };

            function onVisualizeLoaded(v) {
                appendViewportMeta();
                if (jrsServer.pre61) {
                    report = new Report(v)
                } else {
                    report = new Report(v, {
                        animation: false,
                        zoom: false
                    })
                }
                NativeCallbacks.onScriptReady();
            };

             function onVisualizeLoadingFailed(error) {
                var message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            };

            return {
                setup: function (server, options) {
                    jrsServer = server;
                    initOptions = options;

                    setupVisualizeScript(server);
                },
                report: function () {
                    return report;
                }
            }
        }

        function Report(v, chartOptions) {
            this.vis = v;
            this.reportInstance;
            this.chartOptions = chartOptions;

            function reportRenderedFn() {
                jQuery(window).resize(adjustScaleForReport);
                NativeCallbacks.onReportRenedered();
            };

            function reportErrorFn(error) {
                message = JSON.stringify(error);
                NativeCallbacks.onError(message);
            };

            function adjustScaleForReport() {
                var container = jQuery("#container")[0];
                container.style.display = 'none';
                container.offsetHeight;
                container.style.display = '';
            }

            Report.prototype.run = function (uri) {
                 var reportBundle = {
                    resource: uri,
                    container: "#container",
                    scale: "width",
                    success: reportRenderedFn,
                    error: reportErrorFn
                 };
                 if (this.chartOptions) {
                    reportBundle.chart = chartOptions;
                 }
                 this.reportInstance = this.vis.report(reportBundle);
            };
        }

        return {
            getInstance: function() {
                if (!instance) {
                    instance = new Client();
                }
                return instance;
            }
        };
    })();

</script>
</head>
<body>
<div id="container"></div>
</body>