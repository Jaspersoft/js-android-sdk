<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN"
        "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">

<head xmlns="http://www.w3.org/1999/html">

    <title>TIBCO Jaspersoft</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <script type="text/javascript" charset="utf-8" src="http://zeptojs.com/zepto.min.js"></script>
    <script type="text/javascript">
        var NativeCallbacks = {
            onVisualizeReady: function () {
                return Android.onVisualizeReady();
            },
            onDashboardRenedered: function () {
                return Android.onDashboardRenedered();
            },
            onWindowError: function (error) {
                return Android.onWindowError(error);
            },
            onMaximizeStart: function (componentName) {
                return Android.onMaximizeStart(componentName);
            },
            onMaximizeEnd: function (componentName) {
                return Android.onMaximizeEnd(componentName);
            },
            onMinimizeStart: function () {
                return Android.onMinimizeStart(componentName);
            },
            onMinimizeEnd: function (componentName) {
                return Android.onMinimizeEnd(componentName);
            },
            onDashletError: function (error) {
                return Android.onDashletError(error);
            }
        };

        window.Android = window.Android || new Proxy({}, {
            get: function (target, name) {
                return function (args) {
                    var resultArgs = args || [];
                    console.log("Function '" + name + "' has been called with args '" + resultArgs + "' on Android object");
                }
            }
        });

        window.onerror = function (message, source, line, column) {
            var e = {
                message: message,
                source: source,
                line: line,
                column: column
            };
            var errorLog = JSON.stringify(e);
            NativeCallbacks.onWindowError(errorLog);
            return false;
        };

        var MobileClient = (function () {
            var clientContext = this;

            var setupVisualizeScript = function (callback) {
                var visScript = document.createElement('script');
                visScript.onload = callback;
                visScript.setAttribute('src', clientContext.config.server.url + "client/visualize.js?_opt=false");
                document.head.appendChild(visScript);
            };

            var loadVisualize = function (callback) {
                var onComplete = function (v) {
                    var dashboard = new Dashboard(v);
                    clientContext.dashboard = dashboard;

                    if (callback !== undefined) {
                        callback.call(clientContext, dashboard);
                    }

                    NativeCallbacks.onVisualizeReady();
                };

                var auth = clientContext.config.auth;
                if (auth === undefined) {
                    visualize(onComplete);
                } else {
                    visualize({auth: auth}, onComplete);
                }
            };

            function Client() {
                return {
                    setup: function (config, callback) {
                        clientContext.config = config;
                        var loadFunc = loadVisualize.bind(this, callback);
                        setupVisualizeScript(loadFunc);
                    },
                    dashboard: function () {
                        return clientContext.dashboard;
                    }
                }
            }

            function Dashlet6_0(dashboard) {
            }

            function Dashlet6_1Plus(dashboard) {
                var dashletContext = this;
                dashletContext.dashboard = dashboard;
                dashletContext.dashlets = listDashlets();

                configureMaximization();

                function getComponentById(id) {
                    var dashboard = dashletContext.dashboard.instance;
                    var components = dashboard.data().components;
                    var byId = function (c) {
                        return c.id == id;
                    };
                    var filtered = components.filter(byId);
                    return filtered[0];
                }

                function configureMaximization () {
                    dashletContext.dashlets.on("click", function () {
                        var dashboard = dashletContext.dashboard.instance;
                        var dashboardId = dashletContext.dashboard.dashboardId;

                        var dashlet = $(this);
                        var dashletId = dashlet.attr(dashboardId);
                        var component = getComponentById(dashletId);

                        NativeCallbacks.onMaximizeStart(component.name);
                        dashboard.updateComponent(dashletId, {
                                    maximized: true,
                                    interactive: true
                                },
                                function () {
                                    dashletContext.maximized = component;
                                    NativeCallbacks.onMaximizeEnd(component.name);
                                },
                                function (error) {
                                    NativeCallbacks.onDashletError(error);
                                }
                        );
                    });
                }

                function listDashlets () {
                    var dashboard = dashletContext.dashboard.instance;
                    var dashboardId = dashletContext.dashboard.dashboardId;
                    var container = dashboard.container();

                    return $(container).find("[" + dashboardId + "] > .dashlet").parent();
                }

                var minimize = function () {
                    var component = dashletContext.maximized;
                    if (component) {
                        var dashboard = dashletContext.dashboard.instance;

                        NativeCallbacks.onMinimizeStart(component.name);
                        dashboard.updateComponent(component.id, {
                                    maximized: false,
                                    interactive: false
                                },
                                function () {
                                    dashletContext.maximized = undefined;
                                    NativeCallbacks.onMinimizeEnd(component.name);
                                },
                                function (error) {
                                    NativeCallbacks.onDashletError(error);
                                }
                        );
                    }
                };

                return {
                    minimize: minimize
                }
            }

            function Dashboard(visualize) {
                var dashboardContext = this;
                this.visualize = visualize;
                this.dashboardId = visualize.dashboard.componentIdDomAttribute;

                var dashboardRenderedFn = function () {
                    var version = clientContext.config.server.version;
                    if (version >= 6.1) {
                        dashboardContext.dashlet = new Dashlet6_1Plus(dashboardContext);
                    } else {
                        dashboardContext.dashlet = new Dashlet6_0(dashboardContext);
                    }
                    NativeCallbacks.onDashboardRenedered();
                };

                var dashboardErrorFn = function (error) {
                    var errorLog = JSON.stringify(error);
                    console.log(errorLog);
                };

                var runFn = function (uri) {
                    var v = dashboardContext.visualize;
                    dashboardContext.instance = v.dashboard({
                        resource: uri,
                        container: "#container",
                        success: dashboardRenderedFn,
                        error: dashboardErrorFn
                    });
                };

                return {
                    minimizeDashlet: function() {
                        return dashboardContext.dashlet.minimize;
                    },
                    run: runFn
                }
            }

            var instance;
            return {
                instance: function () {
                    if (instance == null) {
                        instance = new Client();
                        instance.constructor = null;
                    }
                    return instance;
                }
            };
        })();
    </script>
</head>
<body>
<div id="container"></div>
</body>